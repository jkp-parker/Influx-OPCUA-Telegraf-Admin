version: "3.9"

# ─────────────────────────────────────────────────────────────────────────────
#  OPC UA Telegraf Admin — Full Sample Stack
#
#  This compose file spins up a complete end-to-end demo environment:
#
#    opc-ua-sim  →  Telegraf (OPC UA input)  →  InfluxDB 3.x  →  Grafana
#                                                ↑
#                               Admin Portal (backend + frontend)
#
#  Access:
#    • Admin Portal  : http://localhost:9077
#    • Grafana       : http://localhost:3000  (admin / grafanapassword)
#    • InfluxDB UI   : http://localhost:8181
#    • InfluxDB Expl : http://localhost:8888
#    • OPC UA Sim    : opc.tcp://localhost:49947
#
#  First-run setup inside the Admin Portal:
#    1. Open http://localhost:9077
#    2. Follow the Setup wizard and enter:
#         InfluxDB URL   : http://influxdb:8181
#         Token          : my-super-secret-admin-token
#         Database       : opcua
#    3. Add an OPC UA device:
#         Endpoint URL   : opc.tcp://opc-ua-sim:49947
#    4. Browse / scan nodes and enable the tags you want.
#    5. Download or apply the generated telegraf.conf.
# ─────────────────────────────────────────────────────────────────────────────

services:

  # ── IoTech OPC UA Simulator ──────────────────────────────────────────────────
  #  Exposes simulated data via Lua-defined nodes (waveforms, counters, data types).
  #  Endpoint: opc.tcp://opc-ua-sim:49947
  #  Image docs: https://docs.iotechsys.com/edge-xrt21/simulators/opc-ua/simulator/overview.html
  opc-ua-sim:
    image: iotechsys/opc-ua-sim:1.2
    container_name: opc-ua-sim
    restart: unless-stopped
    command: -l /example-scripts/simulation.lua
    ports:
      - "49947:49947"   # OPC UA endpoint
    networks:
      - opcua-net

  # ── InfluxDB volume permissions ───────────────────────────────────────────────
  #  influxdb:3-core runs as UID 1500:1500.  Docker named volumes are created
  #  owned by root, so InfluxDB can't write to them without this one-shot fix.
  #  This container runs first, chowns the volume, then exits.
  influxdb-volume-init:
    image: alpine
    container_name: influxdb-volume-init
    restart: "no"
    command:
      - sh
      - -c
      - |
        chown -R 1500:1500 /var/lib/influxdb3/data && \
        chmod -R u=rwX,g=rwX,o=rX /var/lib/influxdb3/data
    volumes:
      - influxdb_data:/var/lib/influxdb3/data

  # ── InfluxDB 3.x (Core) ──────────────────────────────────────────────────────
  #  InfluxDB 3 Core — high-performance time-series engine with SQL + InfluxQL.
  #  NOTE: v3 has no org/user concept — auth is token-only, data lives in databases.
  #  The influxdb-init service creates the "opcua" database on first start.
  influxdb:
    image: influxdb:3-core
    container_name: influxdb
    restart: unless-stopped
    depends_on:
      influxdb-volume-init:
        condition: service_completed_successfully
    ports:
      - "8181:8181"
    environment:
      # Sets the required Bearer token for all API requests.
      INFLUXDB3_AUTH_TOKEN: my-super-secret-admin-token
    command:
      - influxdb3
      - serve
      - --node-id=node0
      - --object-store=file
      - --data-dir=/var/lib/influxdb3/data
      - --plugin-dir=/var/lib/influxdb3/plugins
    volumes:
      - influxdb_data:/var/lib/influxdb3/data
    networks:
      - opcua-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8181/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ── InfluxDB database initialisation ─────────────────────────────────────────
  #  Runs once after InfluxDB is healthy and creates the "opcua" database.
  influxdb-init:
    image: influxdb:3-core
    container_name: influxdb-init
    restart: "no"
    depends_on:
      influxdb:
        condition: service_healthy
    environment:
      INFLUX_HOST: http://influxdb:8181
      INFLUX_TOKEN: my-super-secret-admin-token
      INFLUX_DATABASE: opcua
    entrypoint: ["bash", "/scripts/01-init-database.sh"]
    volumes:
      - ./influxdb/init:/scripts:ro
    networks:
      - opcua-net

  # ── Telegraf ─────────────────────────────────────────────────────────────────
  #  Reads data from the OPC UA simulator and writes to InfluxDB.
  #  The telegraf.conf in ./telegraf/ is pre-configured for this demo stack.
  telegraf:
    image: telegraf:1.30
    container_name: telegraf
    restart: unless-stopped
    depends_on:
      influxdb:
        condition: service_healthy
      opc-ua-sim:
        condition: service_started
    volumes:
      - ./telegraf/telegraf.conf:/etc/telegraf/telegraf.conf:ro
    networks:
      - opcua-net

  # ── InfluxDB 3 Explorer ───────────────────────────────────────────────────────
  #  Web UI for browsing, querying, and managing InfluxDB 3 databases and tokens.
  #  Pre-configured to connect to the local InfluxDB instance via config.json.
  influxdb-explorer:
    image: influxdata/influxdb3-ui:1.6.2
    container_name: influxdb-explorer
    restart: unless-stopped
    ports:
      - "8888:80"
    command: ["--mode=admin"]
    environment:
      # Change this to a secure random value in production: openssl rand -hex 32
      SESSION_SECRET_KEY: "opcua-demo-session-secret-change-in-production"
    volumes:
      - ./influxdb-explorer/config:/app-root/config:ro
    depends_on:
      influxdb:
        condition: service_healthy
    networks:
      - opcua-net

  # ── Grafana ───────────────────────────────────────────────────────────────────
  #  Dashboards and visualisation for InfluxDB data.
  #  The InfluxDB datasource (InfluxQL) is auto-provisioned on first start.
  #
  #  Accounts:
  #    admin / grafanapassword  — full admin access
  #    (anonymous viewers can browse dashboards without logging in)
  grafana:
    image: grafana/grafana:10.4.2
    container_name: grafana
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      # Admin account
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: grafanapassword
      # Allow anonymous read-only access for demo convenience
      GF_AUTH_ANONYMOUS_ENABLED: "true"
      GF_AUTH_ANONYMOUS_ORG_ROLE: Viewer
      # Disable sign-up to keep the demo clean
      GF_USERS_ALLOW_SIGN_UP: "false"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
    depends_on:
      influxdb:
        condition: service_healthy
    networks:
      - opcua-net
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ── Admin Portal — FastAPI backend ──────────────────────────────────────────
  backend:
    build:
      context: ../backend
      dockerfile: Dockerfile
    container_name: opcua-admin-backend
    restart: unless-stopped
    volumes:
      - opcua_data:/app/data
    environment:
      DATABASE_URL: sqlite:////app/data/opcua_admin.db
    networks:
      - opcua-net
    ports:
      - "8000:8000"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/api/metrics')"]
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      influxdb:
        condition: service_healthy

  # ── Admin Portal — React frontend (nginx) ───────────────────────────────────
  frontend:
    build:
      context: ../frontend
      dockerfile: Dockerfile
    container_name: opcua-admin-frontend
    restart: unless-stopped
    ports:
      - "9077:80"
    depends_on:
      - backend
    networks:
      - opcua-net

volumes:
  influxdb_data:
    driver: local
  grafana_data:
    driver: local
  opcua_data:
    driver: local

networks:
  opcua-net:
    driver: bridge
